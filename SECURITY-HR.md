# MiID Security HR Plan

이 문서는 `SECURITY.md`의 권고사항을 사람 중심(의사결정/운영/로직)으로 풀어 쓴 실행 가이드입니다.  
목표는 "무엇을 왜 바꿔야 하는지"를 팀 전체가 같은 언어로 이해하고, 구현 전에 합의 가능한 기준을 만드는 것입니다.

## 1) 우선순위 원칙

- P0: 신원 위조, 타인 이벤트 열람처럼 "즉시 악용 가능한 문제"
- P1: 권한 혼동, 재사용 경합처럼 "보안 경계가 약해지는 문제"
- P2: 방어 심화, 운영 안정성, 구조적 분산화

## 2) 항목별 해결 계획 (로직 중심)

### P0-1. DID Resolution 신뢰 체계 재구성

#### 왜 필요한가
- 현재는 요청자가 제출한 `wallet_url`을 신뢰하여 공개키를 가져옵니다.
- 이 구조는 "검증에 필요한 신뢰 기준"을 공격자가 지정할 수 있게 만듭니다.
- 결과적으로 "서명이 맞다"는 사실이 "당사자 키로 서명했다"는 의미를 보장하지 못합니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **검증자가 신뢰 기준을 선택**하고, 요청자는 신뢰 기준을 선택할 수 없게 합니다.
- 1단계: Wallet 서버를 사전 등록(allowlist/registry)하고, DID별 허용 resolver를 고정합니다.
- 2단계: `did:key` 같은 self-certifying DID를 도입해, 공개키를 외부 URL 조회에 의존하지 않게 합니다.
- 3단계: 향후 Universal Resolver를 붙여도, "요청자가 resolver endpoint를 정하지 못한다"는 원칙을 유지합니다.

#### 무엇이 해결되는가
- 악의적 `wallet_url` 주입으로 가짜 DID Document를 반환하는 공격이 차단됩니다.
- 검증 결과가 "누가 서명했는가"로 일관되게 해석됩니다.
- Gateway 장애/변조 시 전체 신뢰가 무너지는 위험을 줄일 수 있는 기반이 생깁니다.

#### 완료 판정
- 요청 바디에 어떤 URL이 오든 검증 경로가 바뀌지 않아야 합니다.
- 등록되지 않은 resolver/도메인은 항상 거부되어야 합니다.
- 정상 DID는 기존 사용자 경험을 크게 깨지 않고 인증 가능해야 합니다.

---

### P0-2. Wallet Event Stream 인증 도입

#### 왜 필요한가
- 현재는 DID만 알면 이벤트 스트림 구독이 가능한 구조입니다.
- DID는 공개 식별자이므로, 비인가자가 로그인 시도/요청 claims를 관찰할 수 있습니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **이벤트 구독은 DID 소유 증명이 끝난 주체만 가능**해야 합니다.
- Wallet이 짧은 TTL의 connection token을 발급받고, 해당 토큰으로만 SSE 연결을 허용합니다.
- 토큰은 최소한 DID, 발급시각, 만료시각, nonce에 바인딩합니다.
- 연결 횟수/실패 횟수 기준의 rate limit을 적용해 스캐닝 비용을 높입니다.

#### 무엇이 해결되는가
- DID만으로 타인 이벤트를 도청하는 공격이 차단됩니다.
- 대량 DID 추측 기반 모니터링/행동 추적 난이도가 크게 올라갑니다.

#### 완료 판정
- 토큰 없는 연결, 만료 토큰, DID 불일치 토큰은 모두 거부되어야 합니다.
- 정상 Wallet 앱은 동일 UX로 이벤트 수신이 가능해야 합니다.

---

### P1-1. 서명 페이로드의 컨텍스트 바인딩 강화

#### 왜 필요한가
- 서명이 "어떤 서비스 맥락에서 어떤 권한 요청에 대해 생성된 것인지"가 충분히 묶여 있지 않으면 재사용 위험이 생깁니다.
- 현재는 최소 필드만 서명하므로, 동일 `client_id`/유사 환경에서 해석 충돌 가능성이 있습니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **서명은 특정 트랜잭션 맥락에 1:1로 고정**되어야 합니다.
- 서명 대상에 `service_id`, 정규화된 `scopes`, 정규화된 `requested_claims`를 포함합니다.
- 배열/객체는 정렬·정규화 규칙을 명시해, 같은 의미면 항상 같은 canonical payload가 되게 합니다.

#### 무엇이 해결되는가
- 다른 서비스/다른 권한 요청으로 서명을 전용(replay)하기 어려워집니다.
- 검증 실패 원인을 명확히 분리할 수 있어 운영 진단도 쉬워집니다.

#### 완료 판정
- 동일 challenge라도 scope/claim 구성이 다르면 검증에 실패해야 합니다.
- 서비스 컨텍스트가 다르면 서명 재사용이 불가능해야 합니다.

---

### P1-2. Challenge와 대상 DID의 결합 강제

#### 왜 필요한가
- 대상 DID가 비어 있는 challenge는 "누가 승인해도 통과" 가능한 상태가 됩니다.
- 멀티 DID 사용자 환경에서 의도와 다른 신원으로 승인되는 문제가 발생할 수 있습니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **인증 요청은 기본적으로 특정 DID를 목표로 생성**합니다.
- 운영 정책상 DID 미지정 흐름이 필요하면, Wallet에서 DID 선택 단계를 명시적으로 거친 뒤 challenge를 해당 DID로 재바인딩합니다.
- "미지정 challenge 허용"은 예외 정책으로만 두고, 감사 로그를 남깁니다.

#### 무엇이 해결되는가
- 의도치 않은 DID 승인/가입을 줄이고 계정 연결 오류를 예방합니다.
- 사용자 통제권(어떤 신원으로 로그인할지 선택)이 정책적으로 보장됩니다.

#### 완료 판정
- 프로덕션 기본 정책에서 DID 미지정 challenge는 생성/승인이 제한되어야 합니다.
- DID 선택 예외 흐름은 명시적 사용자 동작과 로그가 남아야 합니다.

---

### P1-3. Authorization Code 소비를 원자적으로 전환

#### 왜 필요한가
- "조회 후 사용 처리"가 분리되어 있으면 동시 요청에서 경합이 발생할 수 있습니다.
- 짧은 TTL이 있어도, 경합 구간에서 이중 소비가 이론적으로 가능합니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **코드 검증과 사용 처리를 하나의 원자적 단계로 처리**합니다.
- "아직 미사용인 코드만 소비 성공"이라는 단일 상태전이 규칙을 도입합니다.
- 소비 성공/실패 결과를 기준으로 이후 세션 발급 흐름을 분기합니다.

#### 무엇이 해결되는가
- 동시에 두 번 교환해도 오직 1회만 성공하게 됩니다.
- 재시도/중복 제출에 대한 동작이 예측 가능해집니다.

#### 완료 판정
- 동시 교환 시 정확히 1건만 성공하고 나머지는 재사용 오류를 반환해야 합니다.

---

### P1-4. 세션 재사용 우회 경로 운영 가드

#### 왜 필요한가
- 설정값 실수로 Wallet 승인 없는 재사용 경로가 열리면 정책 위반이 즉시 발생합니다.
- 이 문제는 코드 버그보다 운영 실수에서 자주 발생합니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **운영 환경에서 위험 플래그를 켜는 실수를 시스템이 자체 차단**합니다.
- Production에서 `wallet authoritative` 비활성화 시 서버 기동 실패 또는 강제 read-only 모드로 전환합니다.
- 설정 변경 시 보안 감사 로그/알림을 남깁니다.

#### 무엇이 해결되는가
- 배포 실수 하나로 보안 정책이 무력화되는 리스크를 크게 줄입니다.

#### 완료 판정
- 운영 환경에서 우회 설정으로 서버가 정상 서비스 상태로 올라오지 않아야 합니다.

---

### P1-5. 개발용 고정 자격증명 오배포 방지

#### 왜 필요한가
- 개발 기본값 비밀값은 운영에 유입될 때 치명적입니다.
- 이 이슈의 핵심은 공격 난이도보다 "사고 가능성"입니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **운영에서는 기본값/약한 값이 존재할 수 없게 강제**합니다.
- Production 기동 시 dev prefix·기본 secret 감지 시 즉시 실패 처리합니다.
- CI/CD 배포 게이트에서 동일 검사를 반복합니다.

#### 무엇이 해결되는가
- 운영 오배포로 인한 즉시 침해 가능성을 사전에 차단합니다.

#### 완료 판정
- 운영 설정으로 기본 시크릿이 감지되면 배포/기동이 실패해야 합니다.

---

### P2-1. Wallet 서명 요청 채널 하드닝 (환경변수 secret 의존 축소)

#### 왜 필요한가
- 같은 머신 내 다른 프로세스가 환경변수나 로컬 HTTP 호출을 악용할 여지가 있습니다.
- 현재 방식은 "로컬이니까 안전" 가정이 강합니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **서명 권한은 프로세스 경계가 아닌 신뢰된 실행 경로에 귀속**되어야 합니다.
- 중기 목표로 Wallet App ↔ Wallet Server를 IPC 기반 승인/서명 흐름으로 전환합니다.
- 전환 전에는 short-lived token, loopback 제한, 프로세스 출처 검증을 계층적으로 적용합니다.

#### 무엇이 해결되는가
- 로컬 악성 프로세스가 임의 서명 요청을 보내는 난이도가 크게 상승합니다.

#### 완료 판정
- 비인가 로컬 호출은 서명 권한을 획득할 수 없어야 합니다.

---

### P2-2. Token Exchange에 PoP(PKCE) 도입

#### 왜 필요한가
- Authorization code가 유출되면 현재는 code만으로 토큰 교환이 가능합니다.
- TTL이 짧아도 중간 노출/로그 유출 상황에서는 위험이 남습니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **코드를 받은 주체와 교환하는 주체가 동일함을 증명**합니다.
- challenge 생성 시 code_challenge를 저장하고, 교환 시 code_verifier를 검증합니다.
- 공개 클라이언트부터 우선 적용하고, 기존 클라이언트는 단계적으로 마이그레이션합니다.

#### 무엇이 해결되는가
- 코드 단독 탈취만으로는 토큰 발급이 되지 않습니다.
- 프론트 채널 노출 리스크를 구조적으로 줄입니다.

#### 완료 판정
- 올바른 verifier 없이 교환이 불가능해야 합니다.

---

### P2-3. SSE 전달 보장/복구 로직 보강

#### 왜 필요한가
- 네트워크 단절 시 이벤트 손실이 생기면 승인 UX가 깨지고, 사용자는 실패 원인을 알기 어렵습니다.
- 보안 이벤트가 누락되면 운영 관측성도 저하됩니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **짧은 단절은 자동 복구 가능**해야 합니다.
- 이벤트에 순번(id)을 부여하고, 클라이언트는 마지막 수신 id를 재전송합니다.
- 서버는 제한된 버퍼 구간에 대해 재전송을 지원합니다.

#### 무엇이 해결되는가
- 재연결 직후 누락 이벤트를 보정해 승인/알림 일관성을 높일 수 있습니다.

#### 완료 판정
- 일시 단절 후에도 승인/거절 이벤트가 누락 없이 재수신되어야 합니다.

---

### P2-4. Gateway 역할 분산 (Verifier / Resolver 분리)

#### 왜 필요한가
- 현재 Gateway는 과도한 신뢰 집중 지점입니다.
- 기능 결합도가 높아 장애/침해의 blast radius가 큽니다.

#### 무엇을 바꿀 것인가 (로직)
- 원칙: **신뢰가 큰 기능을 별도 경계로 분리**합니다.
- DID 해석(Resolver), 서명 검증(Verifier), 세션 오케스트레이션(Gateway)을 역할별로 나눕니다.
- 인터페이스 계약(입력/출력/오류 기준)을 먼저 고정한 뒤 점진적으로 분리합니다.

#### 무엇이 해결되는가
- 하나의 컴포넌트 침해가 전체 인증 체계로 확산되는 속도를 늦춥니다.
- 독립 배포/독립 모니터링이 가능해져 운영 복원력이 높아집니다.

#### 완료 판정
- Resolver/Verifier 장애가 Gateway 전체 장애로 즉시 전이되지 않아야 합니다.

## 3) 권장 실행 순서

1. **Phase A (출시 전 필수)**: P0-1, P0-2
2. **Phase B (보안 경계 강화)**: P1-1 ~ P1-5
3. **Phase C (심화/분산화)**: P2-1 ~ P2-4

## 4) 운영 의사결정 체크리스트

- 프로덕션에서 허용할 DID method는 무엇인가 (`did:key` 우선 여부)?
- Wallet 이벤트 구독 토큰의 TTL과 재발급 정책은 어떻게 할 것인가?
- DID 미지정 challenge를 허용할 예외 시나리오가 실제로 필요한가?
- PKCE를 즉시 전체 적용할지, 클라이언트별 단계 적용할지?
- Gateway 분산 시점(트래픽/규제/감사 요구 기준)은 무엇인가?

## 5) 기대 효과 요약

- 신원 위조 가능성 차단 (검증 기준 외부 주입 방지)
- 사용자 프라이버시 보호 (비인가 이벤트 구독 차단)
- 권한 혼동 및 재사용 공격 난이도 상승
- 운영 실수(설정/배포)로 인한 보안 사고 확률 감소
- 중장기적으로 DID 철학(분산 검증, 자기주권)에 더 가까운 구조 확보
